# Go
# Build your Go project.
# Add steps that test, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/go

trigger:
- master

strategy:
  matrix: 
    linux:
      poolName: 'Ubuntu_Pool'
      osName: 'linux'
      ext: ''
    windows:
      poolName: 'Windows_Pool'
      osName: 'windows'
      ext: ".exe"

pool:
  name: $(poolName)

steps:  
- script: |
    go version
    go env
  displayName: 'Checking Go installation'
  
- script: |
    go test -v ./... | true
  workingDirectory: $(Build.SourcesDirectory)/PaymentGateway
  displayName: 'Running all the tests'
  
- script: |
    go build -v
  workingDirectory: $(Build.SourcesDirectory)/PaymentGateway
  displayName: 'Building Payment Gateway'

- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(Build.SourcesDirectory)/PaymentGateway/payment-gateway$(ext)'
    includeRootFolder: true
    archiveType: '7z'
    sevenZipCompression: 'ultra'
    archiveFile: '$(Build.ArtifactStagingDirectory)/payment-gateway-$(osName)-$(Build.BuildId).7z'
    replaceExistingArchive: true
    verbose: true

- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(Build.SourcesDirectory)/PaymentGateway/payment-gateway$(ext)'
    includeRootFolder: true
    archiveType: '7z'
    sevenZipCompression: 'ultra'
    archiveFile: '$(Build.ArtifactStagingDirectory)/payment-gateway-$(osName)-latest.7z'
    replaceExistingArchive: true
    verbose: true

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'payment-gateway'
    publishLocation: 'Container'
